<div class="dashboard-container">

  <!-- Page Header -->
  <mat-toolbar class="page-header" color="primary">
    <mat-toolbar-row>
      <span class="page-title">Client Insights</span>
      <span class="spacer"></span>
      <button mat-icon-button>
        <mat-icon>more_vert</mat-icon>
      </button>
    </mat-toolbar-row>
  </mat-toolbar>

  <!-- Filter and Control Bar -->
  <mat-card class="controls-bar">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field appearance="outline" class="filter-search">
          <mat-label>Choose filter</mat-label>
          <input matInput placeholder="Stores, supplier, delivery date..." />
        </mat-form-field>

        <!-- Date Range Picker for Materials -->
        <div class="date-range-container">
          <app-datetime-picker
            label="Fecha de Inicio"
            placeholder="Seleccionar fecha y hora de inicio"
            [(ngModel)]="materialsStartDate"
            (dateTimeChange)="onMaterialsStartDateChange($event)"
            [showTime]="true"
            class="date-picker-field">
          </app-datetime-picker>
          
          <app-datetime-picker
            label="Fecha de Fin"
            placeholder="Seleccionar fecha y hora de fin"
            [(ngModel)]="materialsEndDate"
            (dateTimeChange)="onMaterialsEndDateChange($event)"
            [showTime]="true"
            [minDate]="materialsStartDate"
            class="date-picker-field">
          </app-datetime-picker>
        </div>

        <button mat-stroked-button color="primary" (click)="addComparison()">
          <mat-icon>add</mat-icon>
          {{ showComparison ? 'Hide comparison' : 'Add comparison' }}
        </button>

        <button mat-raised-button color="primary" (click)="generateReport()" [disabled]="isLoading">
          <mat-icon *ngIf="!isLoading">auto_graph</mat-icon>
          <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
          <span>{{ isLoading ? 'Generating...' : 'Generate' }}</span>
        </button>
      </div>

      <!-- Comparison Section -->
        <mat-expansion-panel *ngIf="showComparison" class="comparison-section">
          <mat-expansion-panel-header>
            <mat-panel-title>Comparison Filters</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="comparison-filters">
            <div class="date-range">
              <mat-form-field appearance="outline">
                <mat-label>From Date</mat-label>
                <input matInput [matDatepicker]="compFromPicker" [(ngModel)]="comparisonFilters.dateRange.from" (dateChange)="onComparisonDateFromChange($event)">
                <mat-datepicker-toggle matSuffix [for]="compFromPicker"></mat-datepicker-toggle>
                <mat-datepicker #compFromPicker></mat-datepicker>
              </mat-form-field>
              
              <mat-form-field appearance="outline">
                <mat-label>To Date</mat-label>
                <input matInput [matDatepicker]="compToPicker" [(ngModel)]="comparisonFilters.dateRange.to" (dateChange)="onComparisonDateToChange($event)">
                <mat-datepicker-toggle matSuffix [for]="compToPicker"></mat-datepicker-toggle>
                <mat-datepicker #compToPicker></mat-datepicker>
              </mat-form-field>
            </div>
            <button mat-raised-button color="primary" (click)="applyComparison()">
              Apply Comparison
            </button>
          </div>
        </mat-expansion-panel>
    </mat-card-content>
  </mat-card>

  <!-- Legend Section -->
  <mat-card class="legend-section">
    <mat-card-content>
      <mat-chip-set>
        <mat-chip *ngFor="let item of legendData">
          <div class="legend-dot" [style.background-color]="item.color"></div>
          <span class="legend-value">{{ item.value }}</span>
          <span class="legend-label" *ngIf="item.label">{{ item.label }}</span>
        </mat-chip>
      </mat-chip-set>
    </mat-card-content>
  </mat-card>

  <!-- Loading Indicator -->
  <div class="loading-indicator" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <span>Loading analytics data...</span>
  </div>

  <!-- Line Graph -->
  <mat-card class="chart-section" [class.loading]="isLoading">
    <mat-card-header>
      <mat-card-title>Analytics Chart</mat-card-title>
      <mat-card-subtitle>Sales and Orders Overview</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="chart-container">
        <div class="line-chart">
          <div class="chart-area">
            <!-- Y-axis labels -->
            <div class="y-axis">
              <div class="y-label" *ngFor="let label of yAxisLabels">
                {{ label }}
              </div>
            </div>

            <!-- Chart line -->
            <div class="chart-line">
              <svg width="100%" height="100%" viewBox="0 0 800 200">
                <polyline
                  [attr.points]="getChartPoints()"
                  class="chart-line-poly"
                  fill="none"
                  stroke="#20B2AA"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <circle
                  *ngFor="let point of getChartPointsArray()"
                  [attr.cx]="point.x"
                  [attr.cy]="point.y"
                  r="4"
                  fill="#20B2AA"
                  stroke="white"
                  stroke-width="2"
                />
              </svg>
            </div>

            <!-- X-axis labels -->
            <div class="x-axis">
              <div class="x-label" *ngFor="let data of analyticsData">
                {{ data.month }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Customer Performance Table -->
  <mat-card class="table-section">
    <mat-card-header>
      <mat-card-title>Customer Performance</mat-card-title>
      <mat-card-subtitle>Sales and Order Analysis</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="customerData" class="performance-table">
          <!-- Customer Column -->
          <ng-container matColumnDef="customer">
            <th mat-header-cell *matHeaderCellDef>Customer</th>
            <td mat-cell *matCellDef="let customer">
              <div class="customer-cell">
                <div class="customer-indicator" [style.background-color]="customer.color"></div>
                {{ customer.name }}
              </div>
            </td>
          </ng-container>

          <!-- Sales Column -->
          <ng-container matColumnDef="sales">
            <th mat-header-cell *matHeaderCellDef>Sales</th>
            <td mat-cell *matCellDef="let customer" class="sales-cell">
              {{ customer.sales | number }}
            </td>
          </ng-container>

          <!-- Orders Column -->
          <ng-container matColumnDef="orders">
            <th mat-header-cell *matHeaderCellDef>Orders</th>
            <td mat-cell *matCellDef="let customer" class="orders-cell">
              {{ customer.orders }}
            </td>
          </ng-container>

          <!-- Average Order Column -->
          <ng-container matColumnDef="averageOrder">
            <th mat-header-cell *matHeaderCellDef>Average Order</th>
            <td mat-cell *matCellDef="let customer" class="avg-order-cell">
              {{ customer.averageOrder | number }}
            </td>
          </ng-container>

          <!-- Frequency Column -->
          <ng-container matColumnDef="frequency">
            <th mat-header-cell *matHeaderCellDef>Frequency</th>
            <td mat-cell *matCellDef="let customer" class="frequency-cell">
              {{ customer.frequency }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
      
      <!-- Summary Row -->
      <mat-divider></mat-divider>
      <div class="summary-section">
        <div class="summary-item">
          <strong>Amount of stores: {{ summaryTotals.totalStores }}</strong>
        </div>
        <div class="summary-item">
          <strong>Total: {{ summaryTotals.totalSales | number }}</strong>
        </div>
        <div class="summary-item">
          <strong>{{ summaryTotals.totalOrders | number }}</strong>
        </div>
        <div class="summary-item">
          <strong>{{ summaryTotals.averageOrder | number }}</strong>
        </div>
        <div class="summary-item">
          <strong>{{ summaryTotals.averageFrequency }}</strong>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Annotations -->
  <mat-card class="annotations">
    <mat-card-content>
      <div class="annotation-item">
        <mat-icon>analytics</mat-icon>
        <span>GRAPHIC (filters): sales orders</span>
      </div>
      <div class="annotation-item">
        <mat-icon>filter_list</mat-icon>
        <span>LIST (Filters)</span>
      </div>
    </mat-card-content>
  </mat-card>
</div>